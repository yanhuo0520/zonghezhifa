<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<title>兽药销售日志-添加</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/mui.css" rel="stylesheet" />
		<link href="ani-css/home.css" rel="stylesheet" />
	</head>
	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">兽药销售企业日常执法监督 </h1>
		</header>
		<div class="mui-content ">
			<div class="log-list-ul">
				<div class="log-list-li"><p class="title">企业名称：</p>
					<p class="desc" id="qymc">济源益农养殖责任有限公司</p></div>
				<div class="log-list-li"><p class="title">企业地址：</p>
					<p class="desc" id="scdz">企业地址 </p></div>
			</div>
			<div class="log-list-ul">
				<div class="log-list-li"><p class="title">检查内容：</p><p class="desc">企业《兽药生产许可证》 </p></div>
				<p class="childArea" style="display: none;"></p>
				<div class="log-list-li"><p class="title">检查方式：</p><p class="desc">查看许可证原件 </p></div>
				<div class="log-list-li">
					<p class="title">检查结果：</p>
					<div class="desc">
						<div class="mui-input-row mui-radio mui-left">
							<label>是</label><input name="radio1" value="是" checked="checked" type="radio">
						</div>
						<div class="mui-input-row mui-radio mui-left">
							<label>否</label><input name="radio1" value="否" type="radio">
						</div>
					</div>
				</div>
			</div>
			<div class="log-list-ul">
				<div class="log-list-li"><p class="title">检查内容：</p><p class="desc">企业名称、经营地址、经营范围与兽药经营许可证一致</p></div>
				<p class="childArea" style="display: none;"></p>
				<div class="log-list-li"><p class="title">检查方式：</p><p class="desc">现场查看、查看许可证原件、副本及经营范围，并进行核对</p></div>
				<div class="log-list-li">
					<p class="title">检查结果：</p>
					<div class="desc">
						<div class="mui-input-row mui-radio mui-left">
							<label>是</label><input name="radio2" value="是" checked="checked" type="radio">
						</div>
						<div class="mui-input-row mui-radio mui-left">
							<label>否</label><input name="radio2" value="否" type="radio">
						</div>
					</div>
				</div>
			</div>
			<div class="log-list-ul">
				<div class="log-list-li"><p class="title">检查内容：</p><p class="desc">所有产品有批准文号</p></div>
				<p class="childArea" style="display: none;"></p>
				<div class="log-list-li"><p class="title">检查方式：</p><p class="desc">现场抽检兽药产品并在中国兽医信息网上核对</p></div>
				<div class="log-list-li">
					<p class="title">检查结果：</p>
					<div class="desc">
						<div class="mui-input-row mui-radio mui-left">
							<label>是</label><input name="radio3" value="是" checked="checked" type="radio">
						</div>
						<div class="mui-input-row mui-radio mui-left">
							<label>否</label><input name="radio3" value="否" type="radio">
						</div>
					</div>
				</div>
			</div>
			<div class="log-list-ul">
				<div class="log-list-li"><p class="title">检查内容：</p><p class="desc">按照GPS规范经营</p></div>
				<p class="childArea" style="display: none;"></p>
				<div class="log-list-li"><p class="title">检查方式：</p><p class="desc">查看制度和有关记录、经营场地和仓库，应与《兽药经营许可证》相符</p></div>
				<div class="log-list-li">
					<p class="title">检查结果：</p>
					<div class="desc">
						<div class="mui-input-row mui-radio mui-left">
							<label>是</label><input name="radio4" value="是" checked="checked" type="radio">
						</div>
						<div class="mui-input-row mui-radio mui-left">
							<label>否</label><input name="radio4" value="否" type="radio">
						</div>
					</div>
				</div>
			</div>
			<div class="log-list-ul">
				<div class="log-list-li"><p class="title">检查内容：</p><p class="desc">建立健全购进和销售台帐</p></div>
				<p class="childArea" style="display: none;"></p>
				<div class="log-list-li"><p class="title">检查方式：</p><p class="desc">检查台帐</p></div>
				<div class="log-list-li">
					<p class="title">检查结果：</p>
					<div class="desc">
						<div class="mui-input-row mui-radio mui-left">
							<label>是</label><input name="radio5" value="是" checked="checked" type="radio">
						</div>
						<div class="mui-input-row mui-radio mui-left">
							<label>否</label><input name="radio5" value="否" type="radio">
						</div>
					</div>
				</div>
			</div>
			<div class="log-list-ul">
				<div class="log-list-li"><p class="title">检查内容：</p><p class="desc">出库入库记录应当规范</p></div>
				<p class="childArea" style="display: none;"></p>
				<div class="log-list-li"><p class="title">检查方式：</p><p class="desc">检查记录</p></div>
				<div class="log-list-li">
					<p class="title">检查结果：</p>
					<div class="desc">
						<div class="mui-input-row mui-radio mui-left">
							<label>是</label><input name="radio6" value="是" checked="checked" type="radio">
						</div>
						<div class="mui-input-row mui-radio mui-left">
							<label>否</label><input name="radio6" value="否" type="radio">
						</div>
					</div>
				</div>
			</div>
			<div class="log-list-ul">
				<div class="log-list-li"><p class="title">检查内容：</p><p class="desc">超范围经营疫苗、人用药</p></div>
				<p class="childArea" style="display: none;"></p>
				<div class="log-list-li"><p class="title">检查方式：</p><p class="desc">查看记录、仓库及现场查看</p></div>
				<div class="log-list-li">
					<p class="title">检查结果：</p>
					<div class="desc">
						<div class="mui-input-row mui-radio mui-left">
							<label>是</label><input name="radio7" value="是" checked="checked" type="radio">
						</div>
						<div class="mui-input-row mui-radio mui-left">
							<label>否</label><input name="radio7" value="否" type="radio">
						</div>
					</div>
				</div>
			</div>
			<div class="log-list-ul">
				<div class="log-list-li"><p class="title">检查内容：</p><p class="desc">经营假劣兽医、违禁药物</p></div>
				<p class="childArea" style="display: none;"></p>
				<div class="log-list-li"><p class="title">检查方式：</p><p class="desc">查看记录、仓库及现场查看</p></div>
				<div class="log-list-li">
					<p class="title">检查结果：</p>
					<div class="desc">
						<div class="mui-input-row mui-radio mui-left">
							<label>是</label><input name="radio8" value="是" checked="checked" type="radio">
						</div>
						<div class="mui-input-row mui-radio mui-left">
							<label>否</label><input name="radio8" value="否" type="radio">
						</div>
					</div>
				</div>
			</div>
			<div class="log-list-ul">
				<div class="log-list-li"><p class="title">检查内容：</p><p class="desc">违规拆零销售原料药</p></div>
				<p class="childArea" style="display: none;"></p>
				<div class="log-list-li"><p class="title">检查方式：</p><p class="desc">查看记录、仓库及现场查看</p></div>
				<div class="log-list-li">
					<p class="title">检查结果：</p>
					<div class="desc">
						<div class="mui-input-row mui-radio mui-left">
							<label>是</label><input name="radio9" value="是" checked="checked" type="radio">
						</div>
						<div class="mui-input-row mui-radio mui-left">
							<label>否</label><input name="radio9" value="否" type="radio">
						</div>
					</div>
				</div>
			</div>
		
			<div class="log-img">
				<p class="title">检查不合格项图片上传</p>
				<ul>
					<div id="upload-content" class="upload-content">
						<!-- <li><img src="ani-image/ad.png" name="" class="max-width picture"><img src="ani-image/close-icon.png" class="detele-icon"></li> -->
					</div>
					<li class="upload-btn" id="upload-btn">
						<img src="ani-image/uploader-img.png" class="max-width">
					</li>
				</ul>
			</div>
			<div class="log-list-ul opinion">
				<p>现场查看发现的其他问题及对所发现的问题提出整改意见(包括上述9条中的问题) </p>
				<textarea placeholder="请输入" id="textArea"></textarea>
			</div>
			<div class="log-list-ul sign-ul">
				<div class="Sign">
					<p class="title">监管对象法定代表人或负责人签字：</p>
					<div class="Sign-cont">
						<img src="" class="sign_show" id="jgrSignImg" />
					</div>
				</div>
				<div class="Sign">
					<p class="title">执法监督人员签字：</p>
					<div class="Sign-cont">
						<img src="" class="sign_show" id="qyfzrSignImg" />
					</div>
				</div>
				<div class="check-time">检查时间：<span id="jcsj">2018-02-08</span> </div>
			</div>
			
			<a href="javascript:;" class="mui-btn log-add-btn" id="save-log">确认</a>
		</div>
		
		
		<div class="mui-backdrop mui-active" style="display: none;"></div>
		<div class="sing-panel zIndex">
			<div class="panel-content">
				<div id="signature"></div>
			</div>
			<div class="panel-btn">
				<a href="javascript:;" class="btn click-hide sure-btn" id="sign_ok">确定</a>
				<a href="javascript:;" class="btn clear-btn" id="sign_clear">清除</a>
				<a href="javascript:;" class="btn click-hide cancel-btn" id="sign_cancel">取消</a>
			</div>
		</div>
		
		<script src="../../js/mui.js"></script>
		<script src="../../js/jquery.min.js"></script>
		<script src="../js/content.js"></script>
		<script src="ani-js/jSignature.js"></script>
		<script src="ani-js/constant.js"></script>
		<script type="text/javascript">
			mui.plusReady(function () {
				// 监控返回操作,刷新上一个页面
				var old_back = mui.back;
				mui.back = function(){
					var opener = plus.webview.currentWebview().opener();
					opener.reload();
					old_back();
				};
				
			    var uuid = plus.storage.getItem("uuid");
			    if(uuid == "" || uuid == null || uuid == "undefined") {
			    	mui.openWindow({
			    		id: 'login.html',
			    		url: '../login.html'
			    	})
			    }
			    var self = plus.webview.currentWebview();
			    var qylx = self.qylx; // 企业类型console.log(qylx);
			    var compId = self.compId; // 企业id
				var compName = self.compName; // 企业名称
				var address = self.address; // 企业地址
				document.getElementById("qymc").innerHTML = compName;
				document.getElementById("scdz").innerHTML = address;
				var myDate = new Date();
				if(myDate.getMonth() < 9){
					var jcsj = myDate.getFullYear()+'-0'+(myDate.getMonth()+1)+'-'+myDate.getDate();
				}else{
					var jcsj = myDate.getFullYear()+'-'+(myDate.getMonth()+1)+'-'+myDate.getDate();
				}
				
				document.getElementById("jcsj").innerHTML = jcsj;

				// 调取图片控件
				document.getElementById('upload-btn').addEventListener('tap', function() {
					if(mui.os.plus) {
						var buttonTit = [{title: "拍照"}, {title: "从手机相册选择"}];
						plus.nativeUI.actionSheet({
							cancel: "取消",
							buttons: buttonTit
						}, function(b) { /*actionSheet 按钮点击事件*/
							switch(b.index) {
								case 0:break;
								case 1:getImage();break; /*拍照*/
								case 2:galleryImgs();break; /*打开相册*/
								default:break;
							}
						})
					}
				}, false);
				// 拍照获取图片
				function getImage() {
					var c = plus.camera.getCamera();
					c.captureImage(function(e) {
						plus.io.resolveLocalFileSystemURL(e, function(entry) {
							var imgPath = entry.toLocalURL(); //图片本地路径/	var name = entry.name; // 图片名称
							if(imgPath.indexOf("/")>0){ //如果包含有"/"号 从最后一个"/"号+1的位置开始截取字符串
								filename=imgPath.substring(imgPath.lastIndexOf("/")+1,imgPath.length);
							}else{
								filename=imgPath;
							}
							var name = /\.[^\.]+$/.exec(filename);
							var random = Math.floor(Math.random()*100000);
							fName = jcsj +'-'+ random + name;

							createUp(imgPath, fName);
						}, function(e) {
							console.log("读取拍照文件错误：" + e.message);
						});
					}, function(s) {
						console.log("error" + s);
					}, {
						filename: "_doc/camera/"
					})
				}
				// 从相册中选择图片
				function galleryImgs(){
					plus.gallery.pick( function(e){
						for(var i in e.files){
							var imgPath = e.files[i];
							if(imgPath.indexOf("/")>0){ //如果包含有"/"号 从最后一个"/"号+1的位置开始截取字符串
								filename=imgPath.substring(imgPath.lastIndexOf("/")+1,imgPath.length);
							}else{
								filename=imgPath;
							}
							var name = /\.[^\.]+$/.exec(filename);
							var random = Math.floor(Math.random()*100000);
							fName = jcsj +'-'+ random + name;
					
							createUp(imgPath, fName);
						}
					}, function (e) {
						console.log( "取消选择图片" );
					},{filter:"image",multiple:true});
				}
				// 上传图片
				function createUp (imgPath, fName) {
					var wt=plus.nativeUI.showWaiting();
					var task = plus.uploader.createUpload(Constant.getConstant("PICTURE_UPLOAD"),
							{method:"POST"},
							function(t,status){ //上传完成
								if(status==200){
									wt.close(); //关闭等待提示按钮
									var msg = eval('(' + t.responseText + ')');
									if(msg.result == "success"){
										plus.nativeUI.toast("上传成功！");
										setHtml(imgPath, fName);
									}else{
										plus.nativeUI.toast("上传失败！");
									}
								}else{
									wt.close();
									console.log("上传失败："+status);
								}
							}
					);
					task.addData("qylx", qylx); //添加其他参数
					task.addData("fileName", fName);
					// 页面中要上传的 图片路径
					task.addFile(imgPath,{key:"image"});
					task.start();
				}
				
				// 确认签字版
				document.getElementById("sign_ok").addEventListener('tap', function() {$(".sign-body").removeClass("bOverhidden");
					var length = $("#signature").jSignature('getData', 'native').length;
					if(length < 1){
						mui.toast('请签名');
					}else{
						$(".mui-content").css("height", "auto");
						$(".mui-content").removeClass("bOverhidden");
						var datapair = $("#signature").jSignature("getData", "image");
						var src = "data:" + datapair[0] + "," + datapair[1];
						bitmapSavePic(src); // 保存签名并上传

						setTimeout(hideCanvas, 100);
					}
				});

				function bitmapSavePic(src){
					var bitmap = new plus.nativeObj.Bitmap("image"); //path: ( String ) 可选 Bitmap对象自动加载图片的地址
					bitmap.loadBase64Data(src, function(e){ //加载base64为数据到bm实例对象
						console.log("加载base64数据成功")
					}, function(error){
						console.log("加载base64数据失败" + error.message)
					} );
					var random = Math.floor(Math.random()*100000);
					fName = jcsj +'-'+random+'.png';
					var path = "_doc/" + fName;
					var options = {"overwrite":true,"format":"png","quality":50};
					bitmap.save( path, options, function(e){ // console.log("保存成功地址："+e.target);
						plus.gallery.save( e.target, function(e){
							createUpSign(e.file, fName);
							console.log("成功" + JSON.stringify(e));
							var Sign = document.getElementsByClassName('Sign');
							for(var i = 0;i <Sign.length;i++){
								if(Sign[i].classList.contains('active')==true){
									Sign[i].children[1].getElementsByTagName('img')[0]['src'] = e.file;
								}
							}
							
						},function(err){
							console.log("保存到相册失败："+ err.message+JSON.stringify(err));
						});
						bitmap.recycle(); //保存到相册后，回收Bitmap图片内存(不可放外面，否则不兼容Android手机)
					}, function(error){
						console.log("保存失败code："+error.code+";msg:"+error.message);
						bitmap.recycle();
					} );
				}
				// 上传图片
				function createUpSign(imgPath, filename) {
					var task = plus.uploader.createUpload(Constant.getConstant("PICTURE_UPLOAD"),{method:"POST"},
							function(t,status){ //上传完成
								if(status==200){
									var msg = eval('(' + t.responseText + ')');
									if(msg.result == "success"){
										console.log("上传成功！");
									}else{
										console.log("上传失败！");
									}
								}else{console.log("上传失败："+status);}
							}
					);
					task.addData("qylx", qylx); //添加其他参数
					task.addData("fileName", filename);
					// 页面中要上传的 图片路径
					task.addFile(imgPath,{key:"image"});
					task.start();
				}
				// 保存日志
				document.getElementById("save-log").addEventListener('tap', function(){
					var jsonobj = {};
					jsonobj["qymc"] = compName;
					jsonobj["scdz"] = address;
					jsonobj["jcsj"] = jcsj;
					jsonobj["syjyxkz"] = $("input:radio[name='radio1']:checked").val();
					jsonobj["mcdzyz"] = $("input:radio[name='radio2']:checked").val();
					jsonobj["pzwh"] = $("input:radio[name='radio3']:checked").val();
					jsonobj["GPS"] = $("input:radio[name='radio4']:checked").val();
					jsonobj["gjxstz"] = $("input:radio[name='radio5']:checked").val();
					jsonobj["ckjlgf"] = $("input:radio[name='radio6']:checked").val();
					jsonobj["cfwjy"] = $("input:radio[name='radio7']:checked").val();
					jsonobj["jlwjyw"] = $("input:radio[name='radio8']:checked").val();
					jsonobj["xsyly"] = $("input:radio[name='radio9']:checked").val();
					jsonobj["zgyj"] = textArea.value;
					// 图片
					var pictureNmae = "";
					var liLength = $("#upload-content").find("li").length;
					for (var k = 0; k < liLength; k++){
						var pName = $("#upload-content").find("li").eq(k).children(".picture").attr("name");
						if (pName != null && pName != "undefined" && pName != "" && pName != "null") {
							filename=pName.substring(pName.lastIndexOf("/")+1,pName.length);
							pictureNmae += filename + ",";
						}
					}
					var pictrueList = pictureNmae.split(",");		
					pictrueListS = pictrueList.slice(0,-1);
					jsonobj["imgname"] = pictrueListS;

					var jgrSignImg = document.getElementById("jgrSignImg").getAttribute("src");
					jgrSignImg = jgrSignImg.substring(jgrSignImg.lastIndexOf("/")+1,jgrSignImg.length);
					if(jgrSignImg == '' || jgrSignImg.length == 0){
						mui.toast("监管人必须签字！");
						return;
					}else{
						jsonobj["jgrSignImg"] = jgrSignImg;
					}
					var qyfzrSignImg = document.getElementById("qyfzrSignImg").getAttribute("src");
					qyfzrSignImg = qyfzrSignImg.substring(qyfzrSignImg.lastIndexOf("/")+1,qyfzrSignImg.length);
					if(qyfzrSignImg == '' || qyfzrSignImg.length == 0){
						mui.toast("企业负责人必须签字！");
						return;
					}else{
						jsonobj["qyfzrSignImg"] = qyfzrSignImg;
					}
					jsonobj["checked"] = 1;
					
					jsonobj = JSON.stringify(jsonobj); 
					plus.nativeUI.showWaiting("正在提交……");
					mui.ajax(Constant.getConstant("COMPANY_LOG_SAVE"), {
						data:{
							"qylx": qylx,
							"a_id": uuid,
							"compId": compId,
							"jsonobj": jsonobj
						},
						dataType:'json',//服务器返回json格式数据
						type:'post',//HTTP请求类型
						timeout:10000,//超时时间设置为10秒；
						success:function(data){
							plus.nativeUI.closeWaiting();
							if(data.result == "success"){
								mui.toast("添加成功");
								setTimeout("mui.back()",200);
							}else{
								mui.toast("添加失败");
							}

						},
						error:function(xhr,type,errorThrown){
							plus.nativeUI.closeWaiting(); 
							mui.toast("查询失败")
						}
					});
				});


			});


			// 点击修改textarea
			var logLen = document.getElementsByClassName("log-list-ul").length;
			var textArea = document.getElementById("textArea");
			for (var i=1;i<=logLen;i++){
				$("input:radio[name='radio"+i+"']").change(function (){
					var innerHtml = $(this).parents('.log-list-li').siblings().children('.desc').html();
					if($(this).val() == "否" || $(this).val() == "无"){
						$(this).parents('.log-list-ul').children('.childArea').html(innerHtml);
						$(this).parents('.log-list-ul').children('.childArea').addClass("showA");
					}else if($(this).val() == "是" || $(this).val() == "有"){
						$(this).parents('.log-list-ul').children('.childArea').html("");
						$(this).parents('.log-list-ul').children('.childArea').removeClass("showA");
					}
					getChildArea();
				});
			}

			// 获取选择内容同步到textarea内容框中
			function getChildArea(){
                var arr = [];
                var strval = "";
                $(".showA").each(function (i) {
                    var a = i+1;
                    var temp =a +"、"+ $(this).text() + "；";
                    arr.push(temp);
                });
                if(arr.length > 0){
                    $.each(arr, function (i, item) {
                        strval += item;
                        textArea.value = strval;
                    });
                }else{
                    textArea.value = "";
                }

            }
		
			$(function() { // 初始化签字版
                $("#signature").jSignature()
            });
			$('.Sign').on('tap', function(){
				$("#signature").jSignature("reset");
				$(this).addClass("active");
				$(this).siblings().removeClass("active");
				setTimeout(showCanvas, 100);
			});
			// 取消签字版
			document.getElementById("sign_cancel").addEventListener('tap', function() {
				$("#signature").jSignature("reset");
				setTimeout(hideCanvas, 100);
			});
			//清空签字版
			document.getElementById("sign_clear").addEventListener('tap', function() {
				$("#signature").jSignature("reset");
			});
			
			function showCanvas(){
				$(".mui-backdrop").show();
				$('.sing-panel').removeClass('zIndex');
			}
			function hideCanvas(){
				$(".mui-backdrop").hide();
				$('.sing-panel').addClass('zIndex');
			}



			// 删除图片
			mui('#upload-content').on('tap', 'li .detele-icon', function(){
				$(this).parents('li').remove();
				plus.nativeUI.toast('删除成功');
			});
			// 填充图片
			function setHtml(imgPath, fName) {
				var str = '';
				str = '<li><img src="'+ imgPath +'" name="'+ fName +'"  class="max-width picture"><img src="ani-image/close-icon.png" class="detele-icon"></li>';
				$("#upload-content").append(str);
			}




		</script>
	</body>

</html>
